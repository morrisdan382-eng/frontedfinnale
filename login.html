<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login – Smart Lighting System</title>

  <link rel="preload" href="assets/logo.png" as="image">
  <link rel="preload" href="assets/room.jpg" as="image">
  <link rel="icon" type="image/x-icon" href="assets/favicon.ico">

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: url("assets/room.jpg") center/cover no-repeat fixed;
      display:flex; justify-content:center; align-items:center; min-height:100vh; padding:20px;
    }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.45); z-index:-1; }
    .login-card {
      background: rgba(255,255,255,0.96);
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 420px;
      padding: 36px 34px;
      text-align: center;
      position: relative;
    }
    .login-card img.logo { width:72px; margin-bottom:18px; display:block; margin-left:auto; margin-right:auto; }
    h2 { margin-bottom:6px; color:#0a3d62; font-size:26px; }
    .subtitle { color:#666; margin-bottom:20px; font-size:14px; }
    .form-group { margin-bottom:14px; text-align:left; }
    label { display:block; margin-bottom:6px; font-weight:600; color:#333; font-size:13px; }
    input, select {
      width:100%; padding:12px 12px; border:2px solid #e6e6e6; border-radius:8px;
      font-size:14px; background:white;
    }
    input:focus, select:focus { outline:none; border-color:#0077ff; box-shadow:0 4px 12px rgba(0,119,255,0.08); }
    .btn {
      width:100%; padding:12px 14px; margin-top:8px; border:none; border-radius:8px;
      background: linear-gradient(135deg,#0077ff,#005fe0); color:white; font-size:16px; font-weight:600;
      cursor:pointer;
    }
    .btn:disabled { opacity:0.7; cursor:not-allowed; }
    .message { display:none; padding:12px; border-radius:8px; margin-bottom:12px; font-size:14px; }
    .message.error { background:#ffebee; color:#c62828; border:1px solid #ffcdd2; }
    .message.success { background:#e8f5e9; color:#2e7d32; border:1px solid #c8e6c9; }
    .extras { margin-top:16px; font-size:13px; color:#666; }
    .extras a { color:#0077ff; text-decoration:none; font-weight:600; }
    @media (max-width:480px) {
      .login-card { padding:28px; max-width:360px; }
      h2 { font-size:22px; }
    }
  </style>
</head>
<body>
  <div class="overlay" aria-hidden="true"></div>

  <main class="login-card" role="main" aria-labelledby="loginTitle">
    <img class="logo" src="assets/logo.png" alt="Smart Lighting Logo" onerror="this.style.display='none'">
    <h2 id="loginTitle">Welcome Back</h2>
    <p class="subtitle">Sign in to access your smart lighting system</p>

    <div id="errorMessage" class="message error" role="alert"></div>
    <div id="successMessage" class="message success" role="status"></div>

    <form id="loginForm" novalidate>
      <div class="form-group">
        <label for="loginUsername">Email</label>
        <input type="email" id="loginUsername" name="username" placeholder="you@example.com" required autocomplete="username">
      </div>

      <div class="form-group">
        <label for="loginPassword">Password</label>
        <input type="password" id="loginPassword" name="password" placeholder="Enter your password" required autocomplete="current-password">
      </div>

      <button type="submit" id="submitBtn" class="btn">Sign In</button>
    </form>

    <div class="extras">Don't have an account? <a href="signup.html">Sign up</a></div>
  </main>

  <script>
    const form = document.getElementById('loginForm');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    const submitBtn = document.getElementById('submitBtn');

    function showError(msg) {
      errorMessage.textContent = msg;
      errorMessage.style.display = 'block';
      successMessage.style.display = 'none';
    }

    function showSuccess(msg) {
      successMessage.textContent = msg;
      successMessage.style.display = 'block';
      errorMessage.style.display = 'none';
    }

    function hideMessages() {
      errorMessage.style.display = 'none';
      successMessage.style.display = 'none';
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideMessages();
      submitBtn.disabled = true;

      const email = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;

      if (!email || !password) {
        showError('Please fill all fields.');
        submitBtn.disabled = false;
        return;
      }

      try {
        const res = await fetch('https://updatebacked.onrender.com/api/users/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }) // no role sent
        });

        const data = await res.json();

        if (!res.ok) {
          showError(data.message || `Login failed (${res.status})`);
          submitBtn.disabled = false;
          return;
        }

        localStorage.setItem('token', data.token);
        localStorage.setItem('user', JSON.stringify(data.user));

        showSuccess('Login successful — redirecting...');
        setTimeout(() => {
          if (data.user.role === 'admin') window.location.href = 'admin.html';
          else window.location.href = 'client.html';
        }, 700);

      } catch (err) {
        console.error('Login request error:', err);
        showError('Failed to reach server. Make sure backend is running and CORS is enabled.');
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
